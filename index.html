<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="./static/css/web-pground.css">
    <link rel="stylesheet" href="./static/css/tabs.css">

    <style>
        .md_container{
            padding: .3em 0 0;
        }
        .header{
            height: 4em;            
            background-color: gray;
        }

        .h_line{
            top: calc(44vh + 2.8em);            
            /* background-color: hotpink; */
        }

        .header select{
            margin: 1em;
            background-color: gray;
            cursor: pointer;            
        }

        .tabs{
            position: absolute;
            top: 43.6vh;
            background-color: transparent;
            left: 3.5em;

            top: 43.2vh;
        }
        .tab{
            font-size: small;
            line-height: 1.6em; 
            padding: 0 0.75em;       
            margin-right: .9em;    
        }
        .tab.active{
            color: azure;
        }
        .tab::before{
            background-color:#292929;
        }

    </style>
</head>

<body>

    <div class="header">

        <select name="compiler_mode" id="compiler_mode">
            <option value="js">js</option>
            <option value="preact" title="^10.6.6">preact</option>
            <option value="vue" title="2.6.14">vue</option>
            <option value="react" title="@17">react</option>            
            <!-- <option value="jsx">jsx</option> -->
        </select>

    </div>

    <div class="md_container">

        <div class="editor" id="htmleditor"></div>
        <div class="editor" id="csseditor"></div>

        <hr class="h_line">
        <div class="center_line"></div>
        <div class="v_line"></div>

        <div class="tabs" style="display: none;">
            <div class="tab" tabindex="0">app.js</div>
            <div class="tab" onclick="fileAttach(event)">+</div>
        </div>
        <div class="editor" id="jseditor"></div>
        <div class="view">
            <div class="expand" data-title="Expand"></div>
        </div>


        <div class="play" title="RUN (press F9)"></div>
    </div>

    <hr>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ext-language_tools.min.js"></script> -->


    <script src="./static/js/ace.js"></script>
    <script src="./static/js/ext-language_tools.min.js"></script>


    <!-- <script src="https://pagecdn.io/lib/ace/1.4.5/ace.js"></script> -->
    
    <!-- <script src="./ace.js"></script> -->
    <!-- <script src="./build/editor.js"></script> -->
    <!-- <script src="./source/ace_initialize.js"></script> -->

    <!-- must have some params for initialization: 1 - preact (and other) relative path, 2 - height for size change line calculation -->


    <script>

        var fileStore = { _active: 0 };

        function fileAttach(event) {

            let filename = prompt('Enter file name:');
            let title = ~filename.indexOf('.') ? filename : (filename + '.js');

            if (~Object.keys(fileStore).indexOf(title)) {
                alert('Файл с таким именем уже существует');
                return;
            }

            // filename
            let origTab = event.target.parentElement.children[0];
            origTab.onclick = origTab.onclick || function (ev) {
                let prevTab = document.querySelector('.tab.active');
                if (prevTab) {

                    prevTab.classList.toggle('active');
                    fileStore[prevTab.innerText] = editors[2].getValue();

                    const defaultExport = fileStore[prevTab.innerText].match(/export default function (\w+)/);
                    if (defaultExport) {
                        // editors[2].session.$mode.$highlightRules.$keywordList.unshift("import " + defaultExport.pop() + " from './" + newTab.innerText + "'");                        
                    }
                }
                ev.target.classList.add('active');

                editors[2].setValue(fileStore[ev.target.innerText]);

                console.log('toggle tab...');
            }

            let newTab = origTab.cloneNode();
            newTab.innerText = title;

            let prevTab = document.querySelector('.tab.active');
            prevTab && prevTab.classList.toggle('active');
            newTab.classList.add('active');

            newTab.style.marginRight = '1.25em';
            newTab.onclick = origTab.onclick;

            fileStore[origTab.innerText] = editors[2].getValue();
            fileStore[newTab.innerText] = '';                   // create new
            editors[2].setValue(fileStore[newTab.innerText]);

            editors[2].session.$mode.$highlightRules.$keywordList.push("from './" + newTab.innerText + "'");

            event.target.parentElement.insertBefore(newTab, event.target);
        }        
    </script>

    <script src="./build/bundler.js"></script>
    <script src="./build/page_builder.js"></script>    

    <!-- test: -->
    <!-- <script src="./build/_preact.js"></script> -->    
    <!-- <script src="https://unpkg.com/vue@3.2.31/dist/vue.global.js"></script> -->

    <script>

        let editors = IDE.initialize({ fileStore });

        window.addEventListener('DOMContentLoaded', function(event) {
            document.querySelector('.tabs').style.display = 'block'
            
            // setTimeout(function() {
            //     editors[2].session.$mode.$highlightRules.$keywordList.push("from ")
            // }, 1000)
        })
    </script>
</body>

</html>
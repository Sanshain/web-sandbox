<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="./static/css/web-pground.css">
    <link rel="stylesheet" href="./static/css/tabs.css">

    <style>
        .md_container{
            padding: .3em 0 0;
        }
        .header{
            height: 4em;            
            background-color: gray;
        }

        .h_line{
            top: calc(44vh + 2.8em);            
            /* background-color: hotpink; */
        }

        .header select{
            margin: 1em;
            background-color: gray;
            cursor: pointer;            
        }

        .tabs{
            position: absolute;
            top: 43.6vh;
            background-color: transparent;
            left: 3.5em;

            top: 43.4vh;
        }
        .tab{
            font-size: small;
            line-height: 1.6em; 
            padding: 0 0.75em;       
            margin-right: .9em;    
        }
        .tab.active{
            color: azure;
        }
        .tab::before{
            background-color:#292929;
        }

        /* meta position */
        .ace_completion-meta{
            color: gray;
        }
        .ace_completion-meta{
            right: 0;
            position: absolute;
            top: -.9em;            
            margin-right: 2em;   
        }
        .ace_line{
            width: 300px;
        }
        /* margin-right: 0.5em;  */


        /*  */        

        .ace_tooltip.ace_doc-tooltip h5{
            margin: 1em 2em;
        }
        .ace_tooltip.ace_doc-tooltip p{
            margin-left: 1em;
            text-transform: capitalize;
            font-weight: 600;
        }

        .settings{
            position: absolute;
            top: .5em;
            right: .5em;
            width: 1.5em;
            height: 1.5em;
            opacity: .6;
            cursor: pointer;  
            background: url(static/images/settings.svg) no-repeat;
            background-size: contain;          
        }
        .expand{
            display: none;
        }

        @media screen and (max-width: 600px) {
            .tabs {
                display: none;
            }
        }
    </style>
</head>

<body>    

    <div class="header">

        <select name="compiler_mode" id="compiler_mode">
            <option value="js">js</option>
            <option value="preact" title="^10.6.6">preact</option>
            <option value="vue" title="2.6.14">vue</option>
            <option value="react" title="@17">react</option>            
            <!-- <option value="jsx">jsx</option> -->
        </select>

    </div>

    <div class="md_container">
        
        <div class="editor" id="htmleditor"></div>
        <div class="editor" id="csseditor"></div>

        <hr class="h_line">
        <div class="center_line"></div>
        <div class="v_line"></div>

        <div class="tabs" style="display: none;">
            <div class="tab" tabindex="0">app.js</div>
            <div class="tab">+</div>
            <!-- onclick="fileAttach(event) -->
        </div>
        <div class="editor" id="jseditor"></div>
        <div class="view">            
            <div class="expand" data-title="Expand"></div>
        </div>


        <div class="play" title="RUN (press F9)"></div>
    </div>

    <hr>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ext-language_tools.min.js"></script> -->


    <script src="./static/js/ace.js"></script>
    <script src="./static/js/ext-language_tools.min.js"></script>


    <!-- <script src="https://pagecdn.io/lib/ace/1.4.5/ace.js"></script> -->
    
    <!-- <script src="./ace.js"></script> -->
    <!-- <script src="./build/editor.js"></script> -->
    <!-- <script src="./source/ace_initialize.js"></script> -->

    <!-- must have some params for initialization: 1 - preact (and other) relative path, 2 - height for size change line calculation -->



    <script src="./build/bundler.js"></script>
    <script src="./build/page_builder.js"></script>    



    <template id="choice-menu">
        <style>
            /* slotted need be styled inline */
            ::slotted(li), 
            li {
                color: white;
                background-color: #666;
                padding: 0.1em 1em 0.1em 2em;
                margin-top: 1px;  
                position: relative;              
            }

            ::slotted(ul), ul{
                margin: 0;
                position: absolute;
                top: 100%;
                right: .1em;
                width: max-content;
                list-style-type: none;  
                display: none;              
            }
            
            /* стили применяемые к самому  my-paragraph*/
            :host {
                margin: 0em;
                /* margin-right: 2em; */
                position: relative;
            }

            ::slotted(.active), .active{
                display: block !important;
            }

            .selected::after, .checked{
                content: '';
                background: url(static/images/check_mark.svg) no-repeat;
                background-size: contain;
                width: 1em;
                height: 2em;
                position: absolute;
                left: .5em;
                top: 0.15em;
            }

            .checked{
                left: auto;
                display: none;
                z-index: 5;
            }
        </style>

        <!-- <slot name="text">My default text</slot> -->
        <div class="checked"></div>
        <slot>
            <ul>
                <li class="selected">item 1</li>
                <li>item 2</li>
            </ul>
        </slot>
    </template>



    <!-- test: -->
    <!-- <script src="./build/_preact.js"></script> -->    
    <!-- <script src="https://unpkg.com/vue@3.2.31/dist/vue.global.js"></script> -->

    <script>

        let editors = IDE.initialize([], {
            tabAttachSelector: '.tab:last-child',
            onControlSave: function(event) {
                // alert(99)
            }
        });


        window.addEventListener('DOMContentLoaded', function(event) {
            document.querySelector('.tabs').style.display = 'block'
            
            // setTimeout(function() {
            //     editors[2].session.$mode.$highlightRules.$keywordList.push("from ")
            // }, 1000)
        })



        customElements.define('choice-menu',
            class extends HTMLElement {

                selectedElement = null;                
                checkedElement = false;
                rootElement = null;

                // get rootElement() { return this._rootElement; };
                // set rootElement(v) {
                //     console.log(v);
                //     this._rootElement = v;
                // }

                constructor() 
                {
                    super();

                          
                    const rootElement = document.getElementById('choice-menu').content.cloneNode(true);
                    const shadowRoot = this.attachShadow({ mode: 'open' }).appendChild(rootElement);

                    let menuElement = this.rootElement = this.shadowRoot.querySelector('ul');
                    const self = this;

                    this.shadowRoot.addEventListener("slotchange", function (event) 
                    {

                        [menuElement] = [self.rootElement] = event.target.assignedElements();
                        self.checkedElement = self.shadowRoot.querySelector('.checked');                          

                        Array.prototype.slice.call(self.rootElement.querySelectorAll('li')).forEach(function(el) 
                        {                            
                            el.onclick = (e) => self.selectedChanged(e);
                            el.style = ' \
                                color: white; \
                                background-color: #666; \
                                padding: 0.1em 1em 0.1em 2em; \
                                margin-top: 1px; \
                                position: relative; \
                            '
                        })

                    });
                    
                    this.onclick = () => {
                        setTimeout(() => 
                        {
                            menuElement.classList.toggle('active');
                            self.checkedElement && self.checkedElement.classList.toggle('active')

                        }, menuElement.classList.contains('active') * 150);
                    }

                    this.rootElement.onclick = this.selectedChanged;

                }

                selectedChanged(e) {
                    if (e.target.tagName === 'li'.toUpperCase()) {

                        if (this.checkedElement){
                            // let checked = this.selectedElement.querySelector('.checked');
                            // if (checked) this.selectedElement.removeChild(checked)

                            this.checkedElement.style.top = event.target.offsetTop + this.offsetHeight + 'px'                                                    
                            this.checkedElement.style.right = this.rootElement.offsetWidth - (16 * 4) + 5 + 'px';  // ?
                        }
                        else{
                            (this.selectedElement || (this.selectedElement = this.rootElement.querySelector('.selected'))) && this.selectedElement.classList.remove('selected');
                            (this.selectedElement = e.target).classList.add('selected');
                        }
                        

                        this.dispatchEvent(new CustomEvent("selected_changed", {
                            detail: {
                                id: e.target.id,
                                metaId: e.target.dataset.id,
                                value: e.target.innerText,
                            }
                        }))
                    }
                }

            }
        );


        editors.forEach(element => {
            // element.container.appendChild(document.createElement('div')).className = 'settings';
            
            const settingsElement = element.container.appendChild(document.createElement('choice-menu'));
            settingsElement.className = 'settings';
            settingsElement.addEventListener('selected_changed', e => {
                console.log(e.detail);
            })
            
            let items = [1,2,3]
            const list = settingsElement.appendChild(document.createElement('ul'));
            items.forEach(point => {
                let itemElement = list.appendChild(document.createElement('li'));
                itemElement.innerText = point;
            })
        }); 

    </script>
</body>

</html>